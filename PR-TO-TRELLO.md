# GitHub PR to Trello Automation

This tool automatically extracts testing information and screenshots from GitHub pull request descriptions and adds them as comments to linked Trello cards.

## Features

- ✅ Fetches GitHub PR by ID
- ✅ Extracts Trello card URL from PR description
- ✅ Parses "How to test" sections from PR descriptions
- ✅ Extracts screenshots (markdown images and HTML img tags)
- ✅ Excludes "Notes for me" sections
- ✅ Posts formatted comment to Trello card
- ✅ Replaces localhost:3000 and localhost:8080 links with a staging base URL
- ✅ Shows a CLI preview and asks for confirmation before posting (with `--yes` to skip)
- ✅ Simple, clean formatting (no heavy bold headers)
- ✅ Screenshots posted as links for better reliability in Trello

## Setup

### 1. Environment Configuration

Copy `.env.example` to `.env` and fill in your credentials:

```bash
cp .env.example .env
```

Required environment variables:

```env
# GitHub API Configuration
GITHUB_TOKEN=your_github_personal_access_token_here

# Trello API Configuration
TRELLO_API_KEY=your_trello_api_key_here
TRELLO_TOKEN=your_trello_token_here

# Optional: Staging URL Replacement
# If set, all localhost:3000 and localhost:8080 links in PR descriptions
# will be replaced with this base URL before posting to Trello.
UR_STAGING_BASE_URL=https://ur-staging.example.com
```

### 2. Get GitHub Personal Access Token

1. Go to GitHub Settings → Developer settings → Personal access tokens
2. Generate a new token with `repo` scope
3. Copy the token to your `.env` file

### 3. Get Trello API Credentials

1. Go to [Trello Developer API Keys](https://trello.com/app-key)
2. Copy your API Key
3. Generate a token by clicking the "Token" link
4. Copy both to your `.env` file

## Usage

### Command Line

```bash
// Directly with node (PR URL)
node pr-to-trello.js https://github.com/myorg/myrepo/pull/1234

// Directly with node (ID + owner/repo)
node pr-to-trello.js 123 myorg/myrepo

// Using npm script (note the -- to pass args)
npm run pr-to-trello -- https://github.com/myorg/myrepo/pull/1234
npm run pr-to-trello -- 123 myorg/myrepo

# Show a preview and confirm (default behavior)
node pr-to-trello.js https://github.com/myorg/myrepo/pull/1234

# Skip confirmation (auto-post)
node pr-to-trello.js https://github.com/myorg/myrepo/pull/1234 --yes

# Omit testing section
node pr-to-trello.js https://github.com/myorg/myrepo/pull/1234 --no-test
```

### What you'll see before posting

The tool prints a preview of the Trello comment to the console and asks:

```
===== Trello Comment Preview =====
...comment body...
==================================
Post this comment to Trello? [y/N]
```

### Programmatic Usage

```javascript
const { processPRToTrello } = require('./pr-to-trello');

// Process PR #123
await processPRToTrello(123);
```

## PR Description Format

The tool looks for these patterns in your PR description:

### Required: Trello Card Link
```markdown
Trello card: https://trello.com/c/abc123/card-name
```

### Testing Section (any of these headers work)
```markdown
## How to test
1. Do this
2. Do that

## Testing
- Step 1
- Step 2

## Test Instructions
Follow these steps...
```

### Screenshots
```markdown
![Screenshot 1](https://example.com/image1.png)
<img src="https://example.com/image2.png" alt="Screenshot 2">
```

### Notes for Me (excluded from Trello)
```markdown
## Notes for me
This section will NOT be sent to Trello
```

## Autogenerated Note

The Trello comment starts with:

```
Converted from GitHub PR (autogenerated)
```

## Example PR Description

```markdown
# Fix user authentication bug

This PR fixes the authentication issue where users couldn't log in.

Trello card: https://trello.com/c/abc123/fix-auth-bug

## How to test
1. Go to login page
2. Enter valid credentials
3. Verify successful login
4. Check that dashboard loads correctly

## Screenshots
![Login page](https://example.com/login.png)
![Dashboard](https://example.com/dashboard.png)

## Notes for me
Remember to update the deployment docs after this is merged.
Don't forget to notify the QA team.
```

## Output

The tool will create a formatted comment on the Trello card containing:

- PR title and link
- Testing instructions
- Screenshots
- Automatic attribution

## Error Handling

The tool provides clear error messages for common issues:

- Missing environment variables
- PR not found
- No Trello URL in PR description
- Invalid Trello card ID
- Network/API errors

## Troubleshooting

### "PR not found"
- Check that the PR ID is correct
- Verify `GITHUB_REPO_OWNER` and `GITHUB_REPO_NAME` are set correctly
- Ensure your GitHub token has access to the repository

### "No Trello card URL found"
- Make sure your PR description contains a valid Trello card URL
- Supported formats: `https://trello.com/c/cardId` or `https://trello.com/c/cardId/card-name`

### "Trello card not found"
- Verify the Trello card URL is accessible
- Check that your Trello token has access to the board
- Ensure the card hasn't been deleted or moved to a private board
